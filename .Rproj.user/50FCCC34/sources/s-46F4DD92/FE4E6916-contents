#	Firma chce wdrożyć odpowiednią komunikację marketingową dla klientów, u których można stwierdzić szanse
# kupna produktu premium. Stwórz model klasyfikacyjny, którego celem jest przewidywanie którzy klienci mogą wykupić usługę premium. Jaka jest skuteczność takiego modelu? Jakie zmienne mają największy wpływ na decyzję o kupnie?
library(dplyr)
library(vroom)
library(lubridate)
library(xgboost)
library(mice)
library(xgboost)
library(matrixStats)
source("VarSummary.R")
data <- readRDS("klienci.RDS")
VarSummary(data)

imputed_data <- mice(data, m=5, maxit = 50, method = 'pmm', seed = 500)
dt <- complete(imputed_data,3)

onehotmatrix <- model.matrix(object = czy_kupil ~ . - 1, data = dt)
col.scale <- colMaxs(abs(onehotmatrix))
x.sc <- sweep(onehotmatrix, 2, col.scale, "/")

dtrain <- xgb.DMatrix(Matrix(x.sc, sparse = TRUE),
                      label = as.integer(dt.fill$income) - 1)
xgb.params <- list(
  "booster" = "gbtree",
  "eta" = 0.05,
  "max_depth" = 4,
  "subsample" = 0.632,
  "colsample_bytree" = 0.4,
  "colsample_bylevel" = 0.6,
  "min_child_weight" = 1,
  "gamma" = 0,
  "lambda" = 0,
  "alpha" = 0,
  "objective" = "binary:logistic",
  "eval_metric" = "auc",
  "silent" = 1,
  "nthread" = 4,
  "num_parallel_tree" = 5
)
set.seed(2020)
cv.out <-
  xgb.cv(
    params = xgb.params,
    data = dtrain,
    nrounds = 1.5e3,
    metrics = list('error'),
    nfold = 5,
    prediction = FALSE,
    verbose = TRUE,
    showsd = FALSE,
    print.every.n = 10,
    early.stop.round = 10,
    maximize = TRUE
  )
